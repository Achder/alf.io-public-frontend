<div *ngIf="reservationInfo && event">

  <app-stepper [currentStep]="3" [free]="event.free"></app-stepper>

  <app-countdown [validity]="reservationInfo.validity" (onExpired)="handleExpired($event)"></app-countdown>

  <form [formGroup]="overviewForm" (submit)="confirm(overviewForm.value)">


    <div class="page-header">
      <h2 translate="reservation-page.title"></h2>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th translate="reservation-page.category"></th>
          <th class="text-center" translate="reservation-page.amount"></th>
          <th class="text-right" translate="reservation-page.price"></th>
          <th class="text-right" translate="reservation-page.subtotal"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let summaryRow of reservationInfo.orderSummary.summary">
          <td>{{summaryRow.name}}</td>
          <td class="text-center">{{summaryRow.amount}}</td>
          <td class="text-right">{{summaryRow.price}}</td>
          <td class="text-right">{{summaryRow.subTotal}} {{event.currency}}</td>
        </tr>
      </tbody>
      <tfoot>
          <tr *ngIf="!reservationInfo.orderSummary.free && reservationInfo.orderSummary.displayVat && !event.vatIncluded">
              <td colspan="3">{{'reservation-page.vat'|translate:{'0': event.vat, '1': 'TODO'} }}</td>
              <td class="text-right">{{reservationInfo.orderSummary.totalVAT}} {{event.currency}}</td>
          </tr>
          <tr>
            <th colspan="3" translate="reservation-page.total"></th>
            <td class="text-right"><strong>{{reservationInfo.orderSummary.totalPrice}} {{event.currency}}</strong></td>
          </tr>
          <tr *ngIf="!reservationInfo.orderSummary.free && reservationInfo.orderSummary.displayVat && event.vatIncluded">
              <td colspan="3">{{'reservation-page.vat-included'|translate: {'0': event.vat, '1': 'TODO'} }}</td>
              <td class="text-right">{{reservationInfo.orderSummary.totalVAT}} {{event.currency}}</td>
          </tr>
          <tr *ngIf="!reservationInfo.orderSummary.free && !reservationInfo.orderSummary.displayVat">
              <td colspan="4">{{'invoice.vat-voided'|translate: {'0': 'TODO'} }}</td>
          </tr>
      </tfoot>
    </table>

    <div *ngIf="!reservationInfo.orderSummary.free">
      <div class="page-header wMarginTop"><h2 translate="reservation-page.payment"></h2></div>

      <div *ngIf="paymentMethodsCount(event) > 1">
          <div class="btn-group btn-group-toggle payment-method-selector wMarginBottom" ngbRadioGroup formControlName="selectedPaymentMethod">
            <label ngbButtonLabel class="btn btn-outline-dark" *ngIf="event.activePaymentMethods['ON_SITE']">
              <input ngbButton type="radio" [value]="'ON_SITE'"><fa-icon [icon]="['fas', 'money-bill']"></fa-icon> {{'reservation-page.on-site'|translate}}
            </label>
            <label ngbButtonLabel class="btn btn-outline-dark" *ngIf="event.activePaymentMethods['BANK_TRANSFER']">
              <input ngbButton type="radio" [value]="'BANK_TRANSFER'"><fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon> {{'reservation-page.offline'|translate}}
            </label>
          </div>
      </div>
      <div *ngIf="paymentMethodsCount(event) === 1">
          <h4 class="wMarginTop" [ngSwitch]="getSinglePaymentMethod(event)">
            <span *ngSwitchCase="'ON_SITE'">
                <fa-icon [icon]="['fas', 'money-bill']"></fa-icon> {{'reservation-page.on-site'|translate}}
            </span>
            <span *ngSwitchCase="'BANK_TRANSFER'">
                <fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon> {{'reservation-page.offline'|translate}}
            </span>
          </h4>
      </div>

      <div *ngIf="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod]" >
          <app-offline-payment-proxy 
            [proxy]="overviewForm.value.paymentMethod" 
            [method]="overviewForm.value.selectedPaymentMethod" 
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters">
          </app-offline-payment-proxy>
          <app-onsite-payment-proxy 
            [proxy]="overviewForm.value.paymentMethod" 
            [method]="overviewForm.value.selectedPaymentMethod" 
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters">
          </app-onsite-payment-proxy>
          <app-stripe-payment-proxy 
            [proxy]="overviewForm.value.paymentMethod" 
            [method]="overviewForm.value.selectedPaymentMethod" 
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters">
          </app-stripe-payment-proxy>
          <app-paypal-payment-proxy 
            [proxy]="overviewForm.value.paymentMethod" 
            [method]="overviewForm.value.selectedPaymentMethod" 
            [parameters]="event.activePaymentMethods[overviewForm.value.selectedPaymentMethod].parameters">
          </app-paypal-payment-proxy>
      </div>
    </div>

    <div>
      <p *ngIf="event.privacyPolicyUrl">
        <label>
          <input formControlName="privacyPolicyAccepted" type="checkbox">{{' '}} <!-- ugly, see  https://github.com/angular/angular/issues/21049 -->
          <span translate="reservation-page.privacy.prefix"></span>{{' '}}<a [attr.href]="event.privacyPolicyUrl" target="_blank" translate="reservation-page.privacy.link.text"></a><span translate="reservation-page.privacy.suffix"></span>
        </label>
      </p>
      <p>
        <label>
          <input formControlName="termAndConditionsAccepted" type="checkbox">{{' '}}
          <span translate="reservation-page.tc.prefix"></span>{{' '}}<a [attr.href]="event.termsAndConditionsUrl" target="_blank" translate="reservation-page.tc.link.text"></a><span translate="reservation-page.tc.suffix"></span>
        </label>
      </p>
    </div>

    <div class="row d-flex justify-content-between">
      <div class="col-md-4 order-1 col-12">
        <button *ngIf="reservationInfo.orderSummary.free" type="submit" class="block-button btn btn-success" translate="reservation-page.continue" [disabled]="expired"></button>
        <button *ngIf="!reservationInfo.orderSummary.free" type="submit" class="block-button btn btn-success" [disabled]="expired">
            {{'reservation-page.pay'|translate}} {{reservationInfo.orderSummary.totalPrice}} {{event.currency}}
        </button>
      </div>
      <div class="col-md-4 order-0 col-12 ">
        <button type="button" class="block-button btn btn-outline-dark" (click)="back()" translate="common.back"></button>
      </div>
    </div>
  </form>
</div>